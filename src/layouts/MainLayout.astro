---
// src/layouts/MainLayout.astro
import { createServerClient, parseCookieHeader } from "@supabase/ssr";
import "../styles/global.css";

interface Props {
    title: string;
}

const { title } = Astro.props;

// Initialisation du client Supabase pour vérifier l'état d'auth côté serveur
const supabaseServer = createServerClient(
    import.meta.env.PUBLIC_SUPABASE_URL,
    import.meta.env.PUBLIC_SUPABASE_ANON_KEY,
    {
        cookies: {
            getAll() {
                const cookies = parseCookieHeader(
                    Astro.request.headers.get("Cookie") ?? "",
                );
                return cookies.map((c) => ({
                    name: c.name,
                    value: c.value ?? "",
                }));
            },
            setAll(cookiesToSet) {
                cookiesToSet.forEach(({ name, value, options }) =>
                    Astro.cookies.set(name, value, options),
                );
            },
        },
    },
);

const {
    data: { user },
} = await supabaseServer.auth.getUser();
---

<!doctype html>
<html lang="fr" class="dark">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
        <meta name="generator" content={Astro.generator} />
        <title>{title} | VTC Premium</title>
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
            rel="stylesheet"
        />
    </head>
    <body
        class="premium-gradient min-h-screen text-slate-50 selection:bg-indigo-500/30"
    >
        <div
            class="fixed inset-0 bg-[url('/grid.svg')] bg-center [mask-image:linear-gradient(180deg,white,rgba(255,255,255,0))] pointer-events-none opacity-20"
        >
        </div>

        <nav
            class="sticky top-0 z-50 w-full glass border-b border-white/5 px-6 py-4"
        >
            <div class="max-w-7xl mx-auto flex items-center justify-between">
                <a
                    href="/"
                    class="flex items-center gap-2 group transition-opacity hover:opacity-80"
                >
                    <div
                        class="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center shadow-lg shadow-indigo-500/20 group-hover:scale-105 transition-transform"
                    >
                        <span class="text-white font-bold text-xl">V</span>
                    </div>
                    <span
                        class="text-xl font-extrabold tracking-tight bg-clip-text text-transparent bg-gradient-to-r from-white to-slate-400"
                    >
                        VTC HUB
                    </span>
                </a>

                <div class="flex items-center gap-6">
                    {
                        user ? (
                            <button
                                id="logout-btn"
                                class="text-sm font-bold text-red-400/80 hover:text-red-400 transition-colors"
                            >
                                Déconnexion
                            </button>
                        ) : (
                            <a
                                href="/login"
                                class="text-sm font-bold text-slate-400 hover:text-white transition-colors"
                            >
                                Connexion
                            </a>
                        )
                    }
                </div>
            </div>
        </nav>

        <main class="relative z-10">
            <slot />
        </main>

        <footer class="mt-20 border-t border-white/5 py-12 px-6 glass">
            <div
                class="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4 text-slate-500 text-sm"
            >
                <div>
                    &copy; {new Date().getFullYear()} VTC HUB. Précision. Luxe. Excellence.
                </div>
                <div class="flex items-center gap-4">
                    <a
                        href="/admin"
                        class="hover:text-indigo-400 transition-colors text-[10px] font-bold uppercase tracking-widest bg-white/5 px-3 py-1 rounded-full border border-white/5"
                        >Admin</a
                    >
                </div>
            </div>
        </footer>

        <script>
            import { supabase } from "../lib/supabase";

            const logoutBtn = document.querySelector("#logout-btn");

            logoutBtn?.addEventListener("click", async () => {
                await supabase.auth.signOut();
                window.location.href = "/";
            });
        </script>
    </body>
</html>
