---
// src/pages/onboarding.astro
import MainLayout from "../layouts/MainLayout.astro";
---

<MainLayout title="Onboarding">
    <div class="max-w-xl mx-auto px-4 py-8">
        <!-- Step Headings -->
        <div id="step-headings" class="mb-8 min-h-[80px]">
            <div class="step-header transition-all duration-300" data-step="1">
                <h2
                    class="text-3xl font-black italic tracking-tighter uppercase"
                >
                    Profil
                </h2>
                <p
                    class="text-slate-500 text-[10px] font-bold uppercase tracking-widest mt-1"
                >
                    IdentitÃ© du titulaire du compte.
                </p>
            </div>
            <div
                class="step-header hidden opacity-0 transition-all duration-300"
                data-step="2"
            >
                <h2
                    class="text-3xl font-black italic tracking-tighter uppercase"
                >
                    VÃ©hicule
                </h2>
                <p
                    class="text-slate-500 text-[10px] font-bold uppercase tracking-widest mt-1"
                >
                    DÃ©tails techniques de votre flotte.
                </p>
            </div>
            <div
                class="step-header hidden opacity-0 transition-all duration-300"
                data-step="3"
            >
                <h2
                    class="text-3xl font-black italic tracking-tighter uppercase"
                >
                    Tarification
                </h2>
                <p
                    class="text-slate-500 text-[10px] font-bold uppercase tracking-widest mt-1"
                >
                    Configuration de vos prix par dÃ©faut.
                </p>
            </div>
        </div>

        <!-- Stepper Indicator -->
        <div class="mb-8 relative px-4">
            <div
                class="absolute top-1/2 left-0 w-full h-0.5 bg-white/5 -translate-y-1/2"
            >
            </div>
            <div
                id="progress-bar"
                class="absolute top-1/2 left-0 h-0.5 bg-indigo-500 -translate-y-1/2 transition-all duration-500 ease-in-out"
                style="width: 0%"
            >
            </div>
            <div class="relative flex justify-between">
                {
                    [1, 2, 3].map((step) => (
                        <div
                            class="step-dot w-8 h-8 rounded-full glass border border-white/10 flex items-center justify-center text-[10px] font-bold z-10 transition-all duration-300"
                            data-step={step}
                        >
                            {step}
                        </div>
                    ))
                }
            </div>
        </div>

        <form id="onboarding-form" class="relative min-h-[300px]">
            <!-- Etape 1: Profil -->
            <div class="step-content space-y-6" data-step="1">
                <div class="space-y-4">
                    <div class="space-y-1">
                        <label
                            class="text-[10px] font-bold text-slate-500 uppercase tracking-tighter"
                            >PrÃ©nom</label
                        >
                        <input
                            type="text"
                            name="first_name"
                            required
                            class="w-full bg-white/5 border border-white/5 rounded-lg px-4 py-3 text-white focus:border-indigo-500/50 outline-none transition-all"
                        />
                    </div>
                    <div class="space-y-1">
                        <label
                            class="text-[10px] font-bold text-slate-500 uppercase tracking-tighter"
                            >Nom</label
                        >
                        <input
                            type="text"
                            name="last_name"
                            required
                            class="w-full bg-white/5 border border-white/5 rounded-lg px-4 py-3 text-white focus:border-indigo-500/50 outline-none transition-all"
                        />
                    </div>
                    <div class="space-y-1">
                        <label
                            class="text-[10px] font-bold text-slate-500 uppercase tracking-tighter"
                            >SociÃ©tÃ©</label
                        >
                        <input
                            type="text"
                            name="company_name"
                            required
                            placeholder="Ex: Prestige VTC"
                            class="w-full bg-white/5 border border-white/5 rounded-lg px-4 py-3 text-white focus:border-indigo-500/50 outline-none transition-all"
                        />
                    </div>
                    <div class="space-y-1">
                        <label
                            class="text-[10px] font-bold text-slate-500 uppercase tracking-tighter"
                            >Sous-domaine</label
                        >
                        <input
                            type="text"
                            name="primary_domain"
                            required
                            placeholder="prestige-vtc"
                            class="w-full bg-white/5 border border-white/5 rounded-lg px-4 py-3 text-white focus:border-indigo-500/50 outline-none transition-all"
                        />
                    </div>
                    <div class="space-y-1">
                        <label
                            class="text-[10px] font-bold text-slate-500 uppercase tracking-tighter"
                            >TÃ©lÃ©phone</label
                        >
                        <div class="flex gap-2">
                            <select
                                name="phone_prefix"
                                class="w-24 bg-white/5 border border-white/5 rounded-lg px-2 py-3 text-white focus:border-indigo-500/50 outline-none transition-all appearance-none cursor-pointer text-xs font-bold uppercase tracking-tighter"
                            >
                                <option
                                    value="+33"
                                    class="bg-[#0a0a0c]"
                                    selected>ðŸ‡«ðŸ‡· +33</option
                                >
                                <option value="+32" class="bg-[#0a0a0c]"
                                    >ðŸ‡§ðŸ‡ª +32</option
                                >
                                <option value="+41" class="bg-[#0a0a0c]"
                                    >ðŸ‡¨ðŸ‡­ +41</option
                                >
                                <option value="+352" class="bg-[#0a0a0c]"
                                    >ðŸ‡±ðŸ‡º +352</option
                                >
                            </select>
                            <input
                                type="tel"
                                name="phone_number"
                                required
                                placeholder="6 00 00 00 00"
                                class="flex-1 bg-white/5 border border-white/5 rounded-lg px-4 py-3 text-white focus:border-indigo-500/50 outline-none transition-all"
                            />
                        </div>
                    </div>
                </div>
            </div>

            <!-- Etape 2: VÃ©hicule -->
            <div class="step-content space-y-6 hidden opacity-0" data-step="2">
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="space-y-1">
                            <label
                                class="text-[10px] font-bold text-slate-500 uppercase tracking-tighter"
                                >Marque</label
                            >
                            <input
                                type="text"
                                name="vehicle_brand"
                                required
                                class="w-full bg-white/5 border border-white/5 rounded-lg px-4 py-3 text-white focus:border-indigo-500/50 outline-none transition-all"
                            />
                        </div>
                        <div class="space-y-1">
                            <label
                                class="text-[10px] font-bold text-slate-500 uppercase tracking-tighter"
                                >ModÃ¨le</label
                            >
                            <input
                                type="text"
                                name="vehicle_model"
                                required
                                class="w-full bg-white/5 border border-white/5 rounded-lg px-4 py-3 text-white focus:border-indigo-500/50 outline-none transition-all"
                            />
                        </div>
                    </div>
                    <div class="space-y-1">
                        <label
                            class="text-[10px] font-bold text-slate-500 uppercase tracking-tighter"
                            >Immatriculation</label
                        >
                        <input
                            type="text"
                            name="plate_number"
                            required
                            class="w-full bg-white/5 border border-white/5 rounded-lg px-4 py-3 text-white focus:border-indigo-500/50 outline-none transition-all"
                        />
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="space-y-1">
                            <label
                                class="text-[10px] font-bold text-slate-500 uppercase tracking-tighter"
                                >Carte VTC</label
                            >
                            <input
                                type="text"
                                name="vtc_license_number"
                                required
                                class="w-full bg-white/5 border border-white/5 rounded-lg px-4 py-3 text-white focus:border-indigo-500/50 outline-none transition-all"
                            />
                        </div>
                        <div class="space-y-1">
                            <label
                                class="text-[10px] font-bold text-slate-500 uppercase tracking-tighter"
                                >CapacitÃ©</label
                            >
                            <input
                                type="number"
                                name="capacity"
                                required
                                min="1"
                                max="12"
                                value="4"
                                class="w-full bg-white/5 border border-white/5 rounded-lg px-4 py-3 text-white focus:border-indigo-500/50 outline-none transition-all"
                            />
                        </div>
                    </div>
                </div>
            </div>

            <!-- Etape 3: Tarifs -->
            <div class="step-content space-y-6 hidden opacity-0" data-step="3">
                <div class="space-y-4">
                    <div class="grid grid-cols-3 gap-4">
                        <div class="space-y-1 text-center">
                            <label
                                class="text-[10px] font-bold text-slate-500 uppercase tracking-tighter"
                                >Base</label
                            >
                            <input
                                type="number"
                                step="0.01"
                                name="default_base_price"
                                required
                                class="w-full bg-white/5 border border-white/5 rounded-lg px-2 py-3 text-white text-center focus:border-indigo-500/50 outline-none transition-all"
                            />
                        </div>
                        <div class="space-y-1 text-center">
                            <label
                                class="text-[10px] font-bold text-slate-500 uppercase tracking-tighter"
                                >KM</label
                            >
                            <input
                                type="number"
                                step="0.01"
                                name="default_price_per_km"
                                required
                                class="w-full bg-white/5 border border-white/5 rounded-lg px-2 py-3 text-white text-center focus:border-indigo-500/50 outline-none transition-all"
                            />
                        </div>
                        <div class="space-y-1 text-center">
                            <label
                                class="text-[10px] font-bold text-slate-500 uppercase tracking-tighter"
                                >Min</label
                            >
                            <input
                                type="number"
                                step="0.01"
                                name="default_minimum_fare"
                                required
                                class="w-full bg-white/5 border border-white/5 rounded-lg px-2 py-3 text-white text-center focus:border-indigo-500/50 outline-none transition-all"
                            />
                        </div>
                    </div>
                    <div class="space-y-2">
                        <label
                            class="text-[10px] font-bold text-slate-500 uppercase tracking-tighter"
                            >CatÃ©gories</label
                        >
                        <div class="flex gap-2">
                            {
                                ["Berline", "Affaires", "Van"].map((c) => (
                                    <label class="flex-1 py-2 rounded-lg border border-white/5 bg-white/5 text-[10px] font-bold uppercase cursor-pointer hover:bg-white/10 transition-all text-center">
                                        <input
                                            type="checkbox"
                                            name="service_categories"
                                            value={c.toLowerCase()}
                                            class="hidden"
                                        />
                                        <span>{c}</span>
                                    </label>
                                ))
                            }
                        </div>
                    </div>
                </div>
            </div>

            <!-- Navigation -->
            <div class="mt-12 flex justify-between gap-4">
                <button
                    type="button"
                    id="prev-btn"
                    class="flex-1 py-4 glass rounded-xl font-bold uppercase tracking-tighter text-xs opacity-0 pointer-events-none transition-all hover:bg-white/10"
                >
                    Retour
                </button>
                <button
                    type="button"
                    id="next-btn"
                    class="flex-1 py-4 bg-indigo-600 rounded-xl font-bold uppercase tracking-tighter text-xs transition-all hover:bg-indigo-500 shadow-lg shadow-indigo-600/20"
                >
                    Suivant
                </button>
                <button
                    type="submit"
                    id="final-btn"
                    class="flex-1 py-4 bg-emerald-600 rounded-xl font-bold uppercase tracking-tighter text-xs transition-all hover:bg-emerald-500 shadow-lg shadow-emerald-600/20 hidden"
                >
                    Finaliser
                </button>
            </div>
        </form>

        <div
            id="status-msg"
            class="mt-6 text-center text-[10px] font-bold uppercase tracking-widest min-h-[12px]"
        >
        </div>
    </div>
</MainLayout>

<script>
    import { supabase } from "../lib/supabase";

    let currentStep = 1;
    const totalSteps = 3;

    const form = document.getElementById("onboarding-form") as HTMLFormElement;
    const contents = document.querySelectorAll(".step-content");
    const headers = document.querySelectorAll(".step-header");
    const dots = document.querySelectorAll(".step-dot");
    const progressBar = document.getElementById(
        "progress-bar",
    ) as HTMLDivElement;
    const nextBtn = document.getElementById("next-btn") as HTMLButtonElement;
    const prevBtn = document.getElementById("prev-btn") as HTMLButtonElement;
    const finalBtn = document.getElementById("final-btn") as HTMLButtonElement;
    const statusEl = document.getElementById("status-msg") as HTMLDivElement;

    function updateUI() {
        // Content & Header visibility
        [contents, headers].forEach((group) => {
            group.forEach((el) => {
                const step = parseInt(el.getAttribute("data-step")!);
                if (step === currentStep) {
                    el.classList.remove("hidden");
                    setTimeout(() => el.classList.remove("opacity-0"), 50);
                } else {
                    el.classList.add("hidden", "opacity-0");
                }
            });
        });

        // Dots & Progress
        dots.forEach((dot) => {
            const step = parseInt(dot.getAttribute("data-step")!);
            if (step <= currentStep) {
                dot.classList.add("border-indigo-500", "text-indigo-400");
            } else {
                dot.classList.remove("border-indigo-500", "text-indigo-400");
            }
        });

        const progress = ((currentStep - 1) / (totalSteps - 1)) * 100;
        progressBar.style.width = `${progress}%`;

        // Buttons
        prevBtn.style.opacity = currentStep === 1 ? "0" : "1";
        prevBtn.style.pointerEvents = currentStep === 1 ? "none" : "auto";

        if (currentStep === totalSteps) {
            nextBtn.classList.add("hidden");
            finalBtn.classList.remove("hidden");
        } else {
            nextBtn.classList.remove("hidden");
            finalBtn.classList.add("hidden");
        }
    }

    nextBtn.addEventListener("click", () => {
        if (currentStep < totalSteps) {
            currentStep++;
            updateUI();
        }
    });

    prevBtn.addEventListener("click", () => {
        if (currentStep > 1) {
            currentStep--;
            updateUI();
        }
    });

    // Checkbox styling toggle
    const checkboxes = document.querySelectorAll('input[type="checkbox"]');
    checkboxes.forEach((cb) => {
        cb.addEventListener("change", (e: any) => {
            const parent = (e.target as HTMLInputElement).parentElement;
            if (e.target.checked) {
                parent?.classList.add(
                    "bg-indigo-500/20",
                    "border-indigo-500/50",
                    "text-indigo-400",
                );
            } else {
                parent?.classList.remove(
                    "bg-indigo-500/20",
                    "border-indigo-500/50",
                    "text-indigo-400",
                );
            }
        });
    });

    form.addEventListener("submit", async (e) => {
        e.preventDefault();
        finalBtn.disabled = true;
        statusEl.textContent = "TRANSMISSION...";
        statusEl.className =
            "mt-6 text-center text-[10px] font-bold uppercase tracking-widest text-indigo-400";

        const formData = new FormData(form);
        const categories = formData.getAll("service_categories");

        try {
            const {
                data: { user },
            } = await supabase.auth.getUser();
            if (!user) throw new Error("AUTH_REQUIRED");

            const phonePrefix = formData.get("phone_prefix") as string;
            const phoneNumber = formData.get("phone_number") as string;
            const fullPhone = `${phonePrefix}${phoneNumber}`.replace(/\s/g, "");

            const { data: obData, error: obError } = await supabase
                .from("onboarding")
                .insert({
                    profile_id: user.id,
                    first_name: formData.get("first_name"),
                    last_name: formData.get("last_name"),
                    company_name: formData.get("company_name"),
                    primary_domain: formData.get("primary_domain"),
                    phone: fullPhone,
                    vtc_license_number: formData.get("vtc_license_number"),
                    vehicle_brand: formData.get("vehicle_brand"),
                    vehicle_model: formData.get("vehicle_model"),
                    plate_number: formData.get("plate_number"),
                    capacity: parseInt(formData.get("capacity") as string),
                    service_categories: categories,
                    default_base_price: parseFloat(
                        formData.get("default_base_price") as string,
                    ),
                    default_price_per_km: parseFloat(
                        formData.get("default_price_per_km") as string,
                    ),
                    default_minimum_fare: parseFloat(
                        formData.get("default_minimum_fare") as string,
                    ),
                    status: "pending",
                })
                .select()
                .single();

            if (obError) throw obError;

            await supabase.functions.invoke("approve_onboarding", {
                body: { onboarding_id: obData.id },
            });

            statusEl.textContent = "SUCCESS - REDIRECTION";
            statusEl.className =
                "mt-6 text-center text-[10px] font-bold uppercase tracking-widest text-emerald-400";
            setTimeout(() => (window.location.href = "/dashboard"), 1500);
        } catch (err: any) {
            statusEl.textContent = "ERROR: " + err.message;
            statusEl.className =
                "mt-6 text-center text-[10px] font-bold uppercase tracking-widest text-red-500";
            finalBtn.disabled = false;
        }
    });

    updateUI();
</script>
