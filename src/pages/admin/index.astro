---
// src/pages/admin/index.astro
import MainLayout from "../../layouts/MainLayout.astro";
import { createServerClient, parseCookieHeader } from "@supabase/ssr";
import { createClient } from "@supabase/supabase-js";

// Initialisation du client standard pour la session
const supabase = createServerClient(
    import.meta.env.PUBLIC_SUPABASE_URL,
    import.meta.env.PUBLIC_SUPABASE_ANON_KEY,
    {
        cookies: {
            getAll() {
                return parseCookieHeader(
                    Astro.request.headers.get("Cookie") ?? "",
                ).map((c) => ({ name: c.name, value: c.value ?? "" }));
            },
            setAll(cookiesToSet) {
                cookiesToSet.forEach(({ name, value, options }) =>
                    Astro.cookies.set(name, value, options),
                );
            },
        },
    },
);

const {
    data: { user },
} = await supabase.auth.getUser();

// Bloquer imm√©diatement si non connect√©
if (!user) {
    return Astro.redirect("/login");
}

// Client Admin (Service Role) pour v√©rification de r√¥le et bypass RLS
const supabaseAdmin = createClient(
    import.meta.env.PUBLIC_SUPABASE_URL,
    import.meta.env.SUPABASE_SERVICE_ROLE_KEY,
);

// üß± 1Ô∏è‚É£ S√©curisation Acc√®s : V√©rifier platform_role
const { data: profile, error: profileError } = await supabaseAdmin
    .from("profiles")
    .select("platform_role")
    .eq("id", user.id)
    .single();

if (profileError) console.error("Admin Profile Error:", profileError);

if (!profile?.platform_role) {
    return Astro.redirect("/");
}

// üß± 2Ô∏è‚É£ Requ√™te Propre : Uniquement les pending via Admin (bypass RLS)
const { data: onboardings, error: obError } = await supabaseAdmin
    .from("onboarding")
    .select("*")
    .eq("status", "pending")
    .order("created_at", { ascending: false });

if (obError) console.error("Admin Fetch Error:", obError);
---

<MainLayout title="Admin - Validation">
    <div class="max-w-7xl mx-auto py-12 px-6">
        <div class="flex items-center justify-between mb-10">
            <div>
                <h1
                    class="text-4xl font-black italic tracking-tighter uppercase bg-clip-text text-transparent bg-gradient-to-r from-white to-slate-500"
                >
                    BackOffice Admin
                </h1>
                <p class="text-slate-400 mt-2">
                    Gestion des dossiers d'onboarding en attente
                </p>
            </div>
            <div
                class="px-4 py-2 bg-indigo-500/10 border border-indigo-500/20 rounded-full text-xs font-bold text-indigo-400 uppercase tracking-widest"
            >
                {onboardings?.length || 0} Dossiers
            </div>
        </div>

        <div class="glass rounded-3xl overflow-hidden border border-white/5">
            <table class="w-full text-left">
                <thead>
                    <tr class="bg-white/5 border-b border-white/5">
                        <th
                            class="px-6 py-4 text-[10px] font-black uppercase tracking-[0.2em] text-slate-500"
                            >Entreprise</th
                        >
                        <th
                            class="px-6 py-4 text-[10px] font-black uppercase tracking-[0.2em] text-slate-500"
                            >Domaine</th
                        >
                        <th
                            class="px-6 py-4 text-[10px] font-black uppercase tracking-[0.2em] text-slate-500"
                            >Email</th
                        >
                        <th
                            class="px-6 py-4 text-[10px] font-black uppercase tracking-[0.2em] text-slate-500"
                            >Cr√©√© le</th
                        >
                        <th
                            class="px-6 py-4 text-[10px] font-black uppercase tracking-[0.2em] text-slate-500"
                            >Status</th
                        >
                        <th
                            class="px-6 py-4 text-right text-[10px] font-black uppercase tracking-[0.2em] text-slate-500"
                            >Action</th
                        >
                    </tr>
                </thead>
                <tbody class="divide-y divide-white/5">
                    {
                        onboardings && onboardings.length > 0 ? (
                            onboardings.map((ob) => (
                                <tr class="hover:bg-white/5 transition-colors group">
                                    <td class="px-6 py-6 font-bold text-white">
                                        {ob.company_name}
                                    </td>
                                    <td class="px-6 py-6 text-[10px] text-indigo-400 font-bold uppercase">
                                        {ob.primary_domain}.vtchub.fr
                                    </td>
                                    <td class="px-6 py-6 text-sm text-slate-300">
                                        {ob.contact_email || "N/A"}
                                    </td>
                                    <td class="px-6 py-6 text-xs text-slate-500">
                                        {new Date(
                                            ob.created_at,
                                        ).toLocaleDateString("fr-FR")}
                                    </td>
                                    <td class="px-6 py-6">
                                        <span class="px-2 py-1 bg-amber-500/10 border border-amber-500/20 rounded text-[10px] font-bold text-amber-400 uppercase tracking-tighter">
                                            {ob.status}
                                        </span>
                                    </td>
                                    <td class="px-6 py-6 text-right">
                                        <button
                                            data-id={ob.id}
                                            class="approve-btn px-6 py-2 bg-emerald-600 hover:bg-emerald-500 text-white text-[10px] font-black uppercase tracking-widest rounded-lg shadow-lg shadow-emerald-600/20 transition-all active:scale-95 disabled:opacity-50"
                                        >
                                            Approuver
                                        </button>
                                    </td>
                                </tr>
                            ))
                        ) : (
                            <tr>
                                <td colspan="6" class="px-6 py-20 text-center">
                                    <span class="text-slate-500 uppercase tracking-widest text-xs font-bold font-inter">
                                        Aucune demande en attente
                                    </span>
                                </td>
                            </tr>
                        )
                    }
                </tbody>
            </table>
        </div>
    </div>
</MainLayout>

<!-- Custom Modal -->
<div
    id="modal-overlay"
    class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[100] hidden items-center justify-center p-6 transition-all duration-300 opacity-0"
>
    <div
        id="modal-content"
        class="glass max-w-md w-full rounded-3xl border border-white/10 p-8 shadow-2xl transform scale-95 transition-all duration-300"
    >
        <div
            id="modal-icon"
            class="w-16 h-16 rounded-2xl bg-emerald-500/10 border border-emerald-500/20 flex items-center justify-center mb-6 mx-auto"
        >
            <div class="w-3 h-3 rounded-full bg-emerald-500 animate-pulse">
            </div>
        </div>
        <h3
            id="modal-title"
            class="text-xl font-black uppercase tracking-widest text-center text-white mb-4 italic"
        >
            Confirmation
        </h3>
        <p
            id="modal-text"
            class="text-slate-400 text-center text-sm mb-8 leading-relaxed font-medium"
        >
            Voulez-vous vraiment activer ce chauffeur ? Cette action cr√©era son
            profil d√©finitif.
        </p>
        <div id="modal-actions" class="flex gap-4">
            <button
                id="modal-cancel"
                class="flex-1 px-6 py-3 bg-white/5 hover:bg-white/10 text-slate-400 text-[10px] font-black uppercase tracking-widest rounded-xl transition-all border border-white/5"
                >Annuler</button
            >
            <button
                id="modal-confirm"
                class="flex-1 px-6 py-3 bg-emerald-600 hover:bg-emerald-500 text-white text-[10px] font-black uppercase tracking-widest rounded-xl shadow-lg shadow-emerald-500/20 transition-all active:scale-95"
                >Confirmer</button
            >
        </div>
        <button
            id="modal-close"
            class="hidden w-full px-6 py-3 bg-white/5 hover:bg-white/10 text-white text-[10px] font-black uppercase tracking-widest rounded-xl transition-all border border-white/5"
            >Fermer</button
        >
    </div>
</div>

<!-- Toast Notification Container -->
<div
    id="toast-container"
    class="fixed top-8 right-8 z-50 flex flex-col gap-4 pointer-events-none"
>
</div>

<script>
    const buttons = document.querySelectorAll(".approve-btn");
    const toastContainer = document.getElementById("toast-container");

    // Modal elements
    const overlay = document.getElementById("modal-overlay");
    const content = document.getElementById("modal-content");
    const mTitle = document.getElementById("modal-title");
    const mText = document.getElementById("modal-text");
    const mActions = document.getElementById("modal-actions");
    const mClose = document.getElementById("modal-close");
    const mCancel = document.getElementById("modal-cancel");
    const mConfirm = document.getElementById("modal-confirm");
    const mIcon = document.getElementById("modal-icon");

    let currentOnboardingId: string | null = null;
    let currentRow: HTMLElement | null = null;
    let currentBtn: HTMLButtonElement | null = null;

    function showModal(
        title: string,
        text: string,
        type: "confirm" | "success" | "error",
    ) {
        if (
            !overlay ||
            !content ||
            !mTitle ||
            !mText ||
            !mActions ||
            !mClose ||
            !mIcon
        )
            return;

        mTitle.textContent = title;
        mText.textContent = text;

        overlay.classList.remove("hidden");
        overlay.classList.add("flex");

        // Types handling
        if (type === "confirm") {
            mActions.classList.remove("hidden");
            mClose.classList.add("hidden");
            mIcon.className =
                "w-16 h-16 rounded-2xl bg-indigo-500/10 border border-indigo-500/20 flex items-center justify-center mb-6 mx-auto";
            mIcon.innerHTML =
                '<div class="w-3 h-3 rounded-full bg-indigo-500 animate-pulse"></div>';
        } else {
            mActions.classList.add("hidden");
            mClose.classList.remove("hidden");
            if (type === "success") {
                mIcon.className =
                    "w-16 h-16 rounded-2xl bg-emerald-500/10 border border-emerald-500/20 flex items-center justify-center mb-6 mx-auto";
                mIcon.innerHTML =
                    '<div class="w-3 h-3 rounded-full bg-emerald-500 animate-pulse"></div>';
            } else {
                mIcon.className =
                    "w-16 h-16 rounded-2xl bg-red-500/10 border border-red-500/20 flex items-center justify-center mb-6 mx-auto";
                mIcon.innerHTML =
                    '<div class="w-3 h-3 rounded-full bg-red-500 animate-pulse"></div>';
            }
        }

        requestAnimationFrame(() => {
            overlay.style.opacity = "1";
            content.style.transform = "scale(1)";
        });
    }

    function closeModal() {
        if (!overlay || !content || !mTitle) return;
        overlay.style.opacity = "0";
        content.style.transform = "scale(0.95)";
        setTimeout(() => {
            overlay.classList.add("hidden");
            overlay.classList.remove("flex");
            if (mTitle.textContent === "Succ√®s") {
                window.location.reload();
            }
        }, 300);
    }

    mCancel?.addEventListener("click", closeModal);
    mClose?.addEventListener("click", () => window.location.reload());

    mConfirm?.addEventListener("click", async () => {
        if (!currentOnboardingId || !currentBtn) return;

        const originalText = currentBtn.textContent;
        currentBtn.disabled = true;
        currentBtn.textContent = "ACTIVATION...";

        const confirmBtn = mConfirm as HTMLButtonElement;
        confirmBtn.disabled = true;
        confirmBtn.textContent = "CHARGEMENT...";

        try {
            const response = await fetch("/api/admin/approve", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ onboarding_id: currentOnboardingId }),
            });

            const result = await response.json();

            if (response.ok) {
                currentBtn.textContent = "ACTIV√â";
                currentBtn.className =
                    "px-6 py-2 bg-emerald-500/10 text-emerald-400 text-[10px] font-black uppercase tracking-widest rounded-lg border border-emerald-500/20 cursor-default";

                if (currentRow) {
                    currentRow.style.transition = "all 0.5s ease";
                    currentRow.style.opacity = "0";
                    currentRow.style.transform = "translateX(-20px)";
                    setTimeout(() => currentRow?.remove(), 500);
                }

                showModal(
                    "Succ√®s",
                    "Le chauffeur a √©t√© activ√© avec succ√®s et poss√®de d√©sormais ses acc√®s complets.",
                    "success",
                );
            } else {
                throw new Error(result.error || "Erreur inconnue");
            }
        } catch (err: any) {
            showModal(
                "Erreur",
                err.message || "Une erreur est survenue lors de l'activation.",
                "error",
            );
            currentBtn.disabled = false;
            currentBtn.textContent = originalText;
            confirmBtn.disabled = false;
            confirmBtn.textContent = "Confirmer";
        }
    });

    function showToast(message: string, type: "success" | "error" = "success") {
        const toast = document.createElement("div");
        toast.className = `px-6 py-4 rounded-xl glass border transition-all duration-500 translate-x-12 opacity-0 flex items-center gap-3 shadow-2xl ${
            type === "success"
                ? "border-emerald-500/20 text-emerald-400"
                : "border-red-500/20 text-red-400"
        }`;

        toast.innerHTML = `
                    <div class="w-2 h-2 rounded-full ${type === "success" ? "bg-emerald-500" : "bg-red-500"} animate-pulse"></div>
                    <span class="text-[10px] font-black uppercase tracking-widest">${message}</span>
                `;

        toastContainer?.appendChild(toast);

        requestAnimationFrame(() => {
            toast.classList.remove("translate-x-12", "opacity-0");
        });

        setTimeout(() => {
            toast.classList.add("translate-x-12", "opacity-0");
            setTimeout(() => toast.remove(), 500);
        }, 3000);
    }

    buttons.forEach((btn) => {
        btn.addEventListener("click", () => {
            currentOnboardingId = btn.getAttribute("data-id");
            currentRow = btn.closest("tr") as HTMLElement;
            currentBtn = btn as HTMLButtonElement;
            showModal(
                "Confirmation",
                "Voulez-vous vraiment activer ce chauffeur ? Cette action cr√©era son profil d√©finitif.",
                "confirm",
            );
        });
    });
</script>
