---
// src/pages/app/bookings.astro
import AppLayout from "../../layouts/AppLayout.astro";
import { supabase } from "../../lib/supabase";

const { profile, user } = Astro.locals;

if (!profile || !user) {
    return Astro.redirect("/login");
}

const safeProfile = profile;

/**
 * üéØ LOGIQUE S√âCURIS√âE (BACKEND SSR)
 * owner / manager -> voient toutes les bookings du tenant
 * driver -> voit uniquement ses bookings
 */
let query = supabase
    .from("bookings")
    .select("*")
    .eq("current_tenant_id", profile.tenant_id);

if (profile.tenant_role === "driver") {
    const { data: driver } = await supabase
        .from("drivers")
        .select("id")
        .eq("user_id", user.id)
        .single();

    if (driver) {
        query = query.eq("driver_id", driver.id);
    } else {
        query = query.eq("id", "00000000-0000-0000-0000-000000000000"); // Force empty result if driver not found
    }
}

const { data: bookings, error } = await query.order("created_at", {
    ascending: false,
});

if (error) console.error("Error fetching bookings:", error);
---

<AppLayout title="Mes Courses">
    <!-- Sticky Header -->
    <div
        class="sticky top-0 z-20 -mt-12 pt-12 pb-8 bg-[#050505]/80 backdrop-blur-md border-b border-white/5 mb-10"
    >
        <span
            class="px-3 py-1 bg-emerald-500/10 border border-emerald-500/20 rounded-full text-[10px] font-black tracking-widest text-emerald-400 uppercase"
        >
            {
                safeProfile.tenant_role === "driver"
                    ? "Mes Courses"
                    : "Toutes les Courses"
            }
        </span>
        <h1 class="text-4xl font-black italic mt-4 uppercase tracking-tighter">
            Historique des Bookings
        </h1>
    </div>

    <div
        class="glass rounded-3xl overflow-hidden border border-white/5 bg-white/[0.01]"
    >
        <table class="w-full text-left">
            <thead class="bg-white/5">
                <tr>
                    <th
                        class="px-6 py-4 text-[10px] font-black uppercase tracking-widest text-slate-500"
                        >Client</th
                    >
                    <th
                        class="px-6 py-4 text-[10px] font-black uppercase tracking-widest text-slate-500"
                        >Date/Heure</th
                    >
                    <th
                        class="px-6 py-4 text-[10px] font-black uppercase tracking-widest text-slate-500"
                        >Statut</th
                    >
                    <th
                        class="px-6 py-4 text-right text-[10px] font-black uppercase tracking-widest text-slate-500"
                        >Montant</th
                    >
                </tr>
            </thead>
            <tbody class="divide-y divide-white/5">
                {
                    bookings && bookings.length > 0 ? (
                        bookings.map((booking) => (
                            <tr class="hover:bg-white/5 transition-colors">
                                <td class="px-6 py-6 font-bold text-white uppercase italic tracking-tighter">
                                    {booking.client_name || "Client"}
                                </td>
                                <td class="px-6 py-6 text-sm text-slate-400">
                                    {new Date(
                                        booking.pickup_time ||
                                            booking.created_at,
                                    ).toLocaleString("fr-FR")}
                                </td>
                                <td class="px-6 py-6">
                                    <span class="px-2 py-1 bg-indigo-500/10 border border-indigo-500/20 rounded text-[10px] font-bold text-indigo-400 uppercase">
                                        {booking.status}
                                    </span>
                                </td>
                                <td class="px-6 py-6 text-right font-black text-indigo-400">
                                    {booking.total_amount || "0"} ‚Ç¨
                                </td>
                            </tr>
                        ))
                    ) : (
                        <tr>
                            <td colspan="4" class="px-6 py-20 text-center">
                                <span class="text-slate-500 uppercase tracking-widest text-xs font-bold font-inter">
                                    Aucune course trouv√©e
                                </span>
                            </td>
                        </tr>
                    )
                }
            </tbody>
        </table>
    </div>
</AppLayout>
